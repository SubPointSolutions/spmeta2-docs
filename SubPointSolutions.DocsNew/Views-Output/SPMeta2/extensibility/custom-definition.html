<html lang="en"><head>    
    <meta charset="utf-8">
    <!-- TITLE OF SITE -->
    <title>SubPoint Solutions</title>
    <meta name="description" content="We enhance your SharePoint experience with excellent APIs, products, and services">
    <meta name="keywords" content="SharePoint, SharePoint Online, SPMeta2, MetaPack, MetaStudio, provision, sp2013, sp2016, o365">
    <meta name="author" content="SubPoint Solutions">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <!-- FAVICON -->
    <link rel="icon" href="/content/img/favicon/favicon.ico">

    <link rel="stylesheet" href="/content/bootstrap.min.css">
    <link rel="stylesheet" href="/content/icons/icons.min.css">
    <link href="http://fonts.googleapis.com/css?family=raleway:300,400,600,700%7copen+sans:300,400,600,700%7chandlee" rel="stylesheet" target="_blank">

    <link rel="stylesheet" href="/content/style.css">
    <link rel="stylesheet" href="/content/responsive.css">
    <link rel="stylesheet" href="/content/colors/red.css" title="red">
    <link rel="stylesheet" href="/content/sps.web.css">

    <link href="/content/syntaxhighlighter/shcore.css" rel="stylesheet">
    <link href="/content/syntaxhighlighter/shcoredefault.css" rel="stylesheet">

    <link href="/content/sps.docs.css" rel="stylesheet">
    <link href="/content/sps.docs.new.css" rel="stylesheet">
    
    <!--[if lt IE 9]>
        <script src="assets/js/plugins/html5shiv.min.js"></script>
        <script src="assets/js/plugins/respond.min.js"></script>
    <![endif]-->
<style>
    .header .overlay {
        height: 500px;
    }

    .company-stat {
        text-align: center;
    }

        .company-stat h4 {
            font-weight: bold;
            color: white;
        }

        .company-stat div.number {
            color: white;
            font-weight: bold;
            font-style: normal;
            font-size: 60px;
        }

        .company-stat div.fact {
            margin-top: 10px;
            color: white;
            font-weight: bold;
            font-style: normal;
            font-size: 23px;
        }

    .wrapper-sm-x {
        padding-top: 25px;
        padding-bottom: 10px;
    }

    .header-landing .vmiddle {
        top: 55%;
    }

    .client-logo img {
        max-height: 60px;
        max-width: 140px;
        opacity: 1;
    }

    .client-logo p {
        margin-bottom: 0px;
    }

    .feature-box .description {
        height: 100px;
    }

    p.tweet a {
        color: #c0392b !important;
    }

    .tweet li span {
        font-style: normal !important;
        font-size: 15px;
    }

    p.interact {
        display: none !important;
    }

    pre  {
        background-color:#ffffff;
    }

    .footer-nav {
        margin-top: 0px !important;
    }

</style></head>



<body>
    <div class="main-wrapper">

        



<nav class="navbar navbar-fixed-top is-scrolling" role="navigation">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="navbar-header">
                    <button data-target=".navbar-collapse" data-toggle="collapse" class="navbar-toggle" type="button">
                        <i class="icon icon_menu"></i>
                    </button>

                            <a href="/" class="navbar-brand " title="SmartMvp">
                                <img src="/content/img/subpoint-logo-25.png" alt="Logo" class=" img-thumbnail img-responsive">
                                <span class="text-logo">SubPoint Solutions - Docs</span>
                            </a>

                </div>

                <div class="navbar-collapse collapse">
                    <ul class="nav navbar-nav navbar-right">

                        <li><a href="http://subpointsolutions.com" title="" target="_blank">Home</a></li>

                        
                        <li><a href="http://docs.subpointsolutions.com" title="" target="_blank">Docs</a></li>
                        
                        
                        <li><a href="https://www.yammer.com/spmeta2feedback/" title="" target="_blank">Community</a></li>
                        <li><a href="http://subpointsolutions.com/company" title="" target="_blank">About</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

<div class="container body-content sd-body-content">

    <div class="row sps-secondnav">
        



<div class="sub-nav" m-current-subfolder="extensibility">



    <h2>
            <a href="/spmeta2/extensibility/index.html">
                Extensibility
            </a> <span>-</span> <span style="font-size: 18px;">Custom definition</span>
        
    </h2>

    <ul>
            <li>
                <a m-subgroup="" class="" href="/spmeta2/index.html">
                    SPMeta2 Home
                </a>
            </li>
            <li>
                <a m-subgroup="getting-started" class="" href="/spmeta2/getting-started/index.html">
                    Getting started
                </a>
            </li>
            <li>
                <a m-subgroup="reference" class="" href="/spmeta2/reference/index.html">
                    Reference
                </a>
            </li>
            <li>
                <a m-subgroup="extensibility" class="active" href="/spmeta2/extensibility/index.html">
                    Extensibility
                </a>
            </li>
            <li>
                <a m-subgroup="scenarios" class="" href="/spmeta2/scenarios/index.html">
                    Scenarios
                </a>
            </li>
            <li>
                <a m-subgroup="kb" class="" href="/spmeta2/kb/index.html">
                    KB
                </a>
            </li>

    </ul>
</div>
    </div>

    <div class="row">

        <div class="col-lg-3 col-md-3 col-sm-3 sps-sidebar">
            

<div class="sd-sidebar panel panel-default hidden-print hidden-xs hidden-sm affix1">
    <ul class="nav ">
                        <li class="root">

                            <a href="/spmeta2/extensibility/index.html">
                                Extensibility
                            </a>
                        </li>
                        <li class="root">

                            <a href="/spmeta2/extensibility/custom-syntax.html">
                                Custom syntax
                            </a>
                        </li>
                        <li class="root active">

                            <a href="/spmeta2/extensibility/custom-definition.html">
                                Custom definition
                            </a>
                        </li>
                        <li class="root">

                            <a href="/spmeta2/extensibility/custom-logging.html">
                                Custom logging
                            </a>
                        </li>
                        <li class="root">

                            <a href="/spmeta2/extensibility/regression-testing.html">
                                Regression testing
                            </a>
                        </li>

    </ul>



</div>
        </div>

        <div class="col-lg-9 col-md-9 col-sm-9 sps-document">
            

<style>
    /*h3 {
        text-align: center;
    }*/
</style><h3>Writing custom definition</h3>
<p>SPMeta2 can be extended with custom definition and model handler, so that you can plug in your own provision logic.
This article provides basics on creating a custom definion and model handler for SPMeta2 library.</p>
<p>Before you begin, make sure you are familiar with the following concepts:</p>
<ul>
<li><a href="/spmeta2/getting-started">Get started with SPMeta2</a></li>
<li><a href="/spmeta2/reference/definitions">Definitions concept</a></li>
<li><a href="/spmeta2/reference/models">Models concept</a></li>
<li><a href="/spmeta2/reference/provisionservices">Provisioning services concept</a></li>
</ul>
<p>Here is a big puctire on how SPMeta2 provision walks through the web model with lists and list views.</p>
<p><img src="http://g.gravizo.com/g?@startuml;
&quot;web definition&quot; -> &quot;web definition&quot;: lookup handler;
&quot;web definition&quot; -> &quot;web definition&quot;: deploymodel();
&quot;web definition&quot; -> &quot;web definition&quot;: lookup children models;
&quot;web definition&quot; -> &quot;list definition&quot;: withresolvingmodelhost(), get web instance;
&quot;list definition&quot; -> &quot;list definition&quot;: lookup handler;
&quot;list definition&quot; -> &quot;list definition&quot;: deploymodel();
&quot;list definition&quot; -> &quot;list definition&quot;: lookup children models;
&quot;list definition&quot; -> &quot;list view definition&quot;: withresolvingmodelhost(), get list instance;
&quot;list view definition&quot; -> &quot;list view definition&quot;: lookup handler;
&quot;list view definition&quot; -> &quot;list view definition&quot;: deploymodel();
&quot;list view definition&quot; -> &quot;list definition&quot;: back;
&quot;list definition&quot; -> &quot;web definition&quot;: back;@enduml" class=" img-thumbnail img-responsive"></p>
<p>At the end, SPMeta2 provision service walks through the model tree resolving correct model handler and calling a pair of DeployModel() and WithResolvingModelHost() methods.</p>
<p>All model handlers must inherit ModelHandlerBase class and implement the following methods:</p>
<ul>
<li>DeployModel(object modelHost, DefinitionBase model) method</li>
<li>TargetType property</li>
<li>Optionally, WithResolvingModelHost(ModelHostResolveContext context) method</li>
</ul>
<p>DeployModel() methods must also raise a pair of OnProvisioning / OnProvisioned event, so that it would be possible to get access to the raw SharePoint object during the provision.</p>
<p>Let's have a closer look and create a simple custom definition with model handler.</p>
<h3>Scenario</h3>
<p>We need to have a custom defintion to change existing web title and description.</p>
<h4>Creating definition</h4>
<p>All definition should meet the following criterias:</p>
<ul>
<li>Inherit DefinitionBase class</li>
<li>Have [Serializable] attribute</li>
</ul>
<p>Here is how a custom ChangeWebTitleAndDescriptionDefinition might look like:</p>
<pre><code class="language-cs">
public class ChangeWebTitleAndDescriptionDefinition : DefinitionBase
{
    public string Title { get; set; }
    public string Description { get; set; }
}

</code></pre>
<h4>Creating model handlers</h4>
<p>The next step would be creating a custom model handler:</p>
<pre><code class="language-cs">
public class ChangeWebTitleAndDescriptionModelHandler : CSOMModelHandlerBase
{
    public override Type TargetType
    {
        get { return typeof(ChangeWebTitleAndDescriptionDefinition); }
    }

    public override void DeployModel(object modelHost, DefinitionBase model)
    {
        var webModeHost = modelHost.WithAssertAndCast&lt;WebModelHost&gt;(
                                    "model",
                                    value =&gt; value.RequireNotNull());

        var definition = model.WithAssertAndCast&lt;ChangeWebTitleAndDescriptionDefinition&gt;(
                                    "model",
                                    value =&gt; value.RequireNotNull());

        var currentWeb = webModeHost.HostWeb;
        var context = currentWeb.Context;

        // raise OnProvisioning event
        InvokeOnModelEvent(this, new ModelEventArgs
        {
            CurrentModelNode = null,
            Model = null,
            EventType = ModelEventType.OnProvisioning,
            Object = currentWeb,
            ObjectType = typeof(Web),
            ObjectDefinition = definition,
            ModelHost = modelHost
        });

        // do stuff
        currentWeb.Title = definition.Title;
        currentWeb.Description = definition.Description;

        // raise OnProvisioned event
        InvokeOnModelEvent(this, new ModelEventArgs
        {
            CurrentModelNode = null,
            Model = null,
            EventType = ModelEventType.OnProvisioned,
            Object = currentWeb,
            ObjectType = typeof(Web),
            ObjectDefinition = definition,
            ModelHost = modelHost
        });

        currentWeb.Update();
        context.ExecuteQuery();
    }
}

</code></pre>
<h4>Registering model handler</h4>
<p>One you created a custom model handler, we need to let SPMeta2 know about it.</p>
<p>Provision service have the following methods to address this:</p>
<ul>
<li>RegisterModelHandler(ModelHandlerBase modelHandlerType)</li>
<li>RegisterModelHandlers(Assembly assembly)</li>
</ul>
<p>Let's use the first one and register our handler:</p>
<pre><code class="language-cs">
var csomProvisionService = new CSOMProvisionService();

csomProvisionService.RegisterModelHandler(new ChangeWebTitleAndDescriptionModelHandler());

var webModel = SPMeta2Model.NewWebModel(web =&gt;
{
    web.AddDefinitionNode(new ChangeWebTitleAndDescriptionDefinition
    {
        Title = "A new name for the web",
        Description = "Some changes done by ChangeWebTitleAndDescriptionDefinition"
    });
});

using (var clientContext = new ClientContext(CSOMSiteUrl))
    csomProvisionService.DeployWebModel(clientContext, webModel);


</code></pre>
<h4>Custom syntax</h4>
<p>There is a separate article on how to create a <a href="/spmeta2/extensibility/writing-custom-syntax/">custom syntax extensions</a>, so let's just improve our provision and add custom syntax for ChangeWebTitleAndDescriptionDefinition:</p>
<pre><code class="language-cs">
public static class ChangeWebTitleAndDescriptionDefinitionSyntax
{
    public static ModelNode AddChangeWebTitleAndDescription(this ModelNode model,
        ChangeWebTitleAndDescriptionDefinition definition)
    {
        return AddChangeWebTitleAndDescription(model, definition, null);
    }

    public static ModelNode AddChangeWebTitleAndDescription(this ModelNode model,
        ChangeWebTitleAndDescriptionDefinition definition, Action&lt;ModelNode&gt;
        action)
    {
        return model.AddDefinitionNode(definition, action);
    }
}

</code></pre>
<p>Now we can re-write provision with a better syntax:</p>
<pre><code class="language-cs">
var csomProvisionService = new CSOMProvisionService();

csomProvisionService.RegisterModelHandler(new ChangeWebTitleAndDescriptionModelHandler());

var webModel = SPMeta2Model.NewWebModel(web =&gt;
{
    web.AddChangeWebTitleAndDescription(new ChangeWebTitleAndDescriptionDefinition
    {
        Title = "A new name for the web",
        Description = "Some changes done by ChangeWebTitleAndDescriptionDefinition"
    });
});

using (var clientContext = new ClientContext(CSOMSiteUrl))
    csomProvisionService.DeployWebModel(clientContext, webModel);


</code></pre>
<h4>Handling events</h4>
<p>We expect that our model handler would raise OnProvisioning / OnProvisioned while pushing definition to SharePoint. Let's attache to these events and see how it goes.</p>
<pre><code class="language-cs">
var csomProvisionService = new CSOMProvisionService();

csomProvisionService.RegisterModelHandler(new ChangeWebTitleAndDescriptionModelHandler());

var webModel = SPMeta2Model.NewWebModel(web =&gt;
{
    web.AddChangeWebTitleAndDescription(new ChangeWebTitleAndDescriptionDefinition
    {
        Title = "A new name for the web",
        Description = "Some changes done by ChangeWebTitleAndDescriptionDefinition"
    },
    changeWebAndTitle =&gt;
    {
        changeWebAndTitle.OnProvisioning&lt;Web, ChangeWebTitleAndDescriptionDefinition&gt;(cntx =&gt;
        {
            var cntxWeb = cntx.Object;
            var cntxDef = cntx.ObjectDefinition;

            // do stuff
        });

        changeWebAndTitle.OnProvisioned&lt;Web, ChangeWebTitleAndDescriptionDefinition&gt;(cntx =&gt;
        {
            var cntxWeb = cntx.Object;
            var cntxDef = cntx.ObjectDefinition;

            // do stuff
        });
    });
});

using (var clientContext = new ClientContext(CSOMSiteUrl))
    csomProvisionService.DeployWebModel(clientContext, webModel);


</code></pre>



            

    <div class="m-prevNextNav-cnt">
            <a class="btn-lg btn-default m-btn-prev" href="/spmeta2/extensibility/custom-syntax.html">
                <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span> Previous
            </a>
                    <a class="btn-lg btn-default pull-right m-btn-next" href="/spmeta2/extensibility/custom-logging.html">
                Next <span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span>
            </a>
    </div>

        </div>

        

    </div>
</div>


        <footer class="footer dark-bg" id="footer">
    <div class="container">
        <div class="wrapper-lg">
            <div class="row">
                <!-- Footer Left Col -->
                <div class="col-md-4">
                    <!-- Logo -->


                    <h5 class="text-white">
                        <img src="/content/img/subpoint-logo-25.png" alt="Logo" class=" img-thumbnail img-responsive">
                        SubPoint Solutions
                    </h5>

                    <p class="footer-hero">
                        Enhancing your SharePoint experience with excellent APIs, products, and services so that you can focus on business-critical tasks.
                        Recognized and trusted since 2013.
                    </p>
                </div>
                <!-- Footer Contact Col -->
                <div class="col-md-4">
                    <h5 class="text-white">Our Contacts</h5>
                    <div class="contact-item">
                        <div class="contact-content">
                            Email:<br>
                            <a style="font-size: 14px;" href="mailto:support@subpointsolutions.com">support@subpointsolutions.com</a>
                        </div>

                        <div class="contact-content">
                            Yammer Network:<br>
                            <a style="font-size: 14px;" href="https://www.yammer.com/spmeta2feedback" target="_blank">https://www.yammer.com/spmeta2feedback</a>
                        </div>


                    </div>
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="icon icon_pin"></i>
                        </div>
                        <div class="contact-content">
                            Sydney, NSW 2000 Australia
                        </div>
                    </div>
                </div>
                <!-- Footer Right Col: Twitter Feed -->
                <div class="col-md-4">
                    <h5 class="text-white">Recent Tweets</h5>

                    <div class="tweet" id="twitter-cnt">

                    </div>
                </div>

                <!-- Footer Menu and Copy -->
               
            </div>

            <div class="row">
                <div class="col-md-12">
                    <ul class="footer-nav">
                        <li>
                            <a href="/company">Company</a>
                        </li>
                        
                        <li>
                            <a href="/terms">Terms Of Use</a>
                        </li>
                        <li>
                            <a href="/privacy">Privacy Policy</a>
                        </li>
                    </ul>
                    <p class="footer-copy">

                        Copyright © <a hre="http://subpointsolutions.com" target="_blank">SubPoint Solutions</a> 2017. 
                        Built with care, <a href="http://wyam.io" target="_blank">Wyam</a> and <a href="https://www.netlify.com/" target="_blank">Netlify</a>. Last updated Sun, 30 Apr 2017 21:59:18 GMT.
                    </p>
                </div>
            </div>
        </div>
    </div>
</footer>

    </div>

    <script src="/scripts/jquery-1.9.1.min.js"></script>
    <script src="/scripts/bootstrap.js"></script>

    <script src="/scripts/syntaxhighlighter/shcore.js"></script>
    <script src="/scripts/syntaxhighlighter/shbrushcsharp.js"></script>
    <script src="/scripts/syntaxhighlighter/shbrushxml.js"></script>
    <script src="/scripts/syntaxhighlighter/shbrushjscript.js"></script>
    <script src="/scripts/syntaxhighlighter/shbrushpowershell.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/2.2.2/isotope.pkgd.min.js"></script>


    

    


    <script>

        (function ($) {

            $(document).ready(function () {

                $('code.language-cs')
                    .addClass('brush: csharp;');

                $('code.language-xml')
                    .addClass('brush: xml;');

                $('code.language-js')
                    .addClass('brush: js;');
                    
                $('code.language-ps')
                       .addClass('brush: ps;');

                SyntaxHighlighter.defaults['quick-code'] = false;
                SyntaxHighlighter.config.tagName = 'code';
                SyntaxHighlighter.all();
            });

            $(document).ready(function () {
                $("body").bind("keydown", function (event) {

                    console.log(event);

                    if (event.ctrlKey && event.keyCode == 37) {

                        if ($('a.m-btn-prev').size() > 0) {
                            var href = $('a.m-btn-prev').attr('href');

                            window.location.href = href;
                        }
                    }

                    if (event.ctrlKey && event.keyCode == 39) {
                        if ($('a.m-btn-next').size() > 0) {
                            var href = $('a.m-btn-next').attr('href');

                            window.location.href = href;
                        }
                    }
                });
            });

        }(jQuery));

    </script>


</body></html>