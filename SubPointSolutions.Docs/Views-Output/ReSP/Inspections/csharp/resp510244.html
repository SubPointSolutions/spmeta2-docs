<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunWithElevatedPrivileges is used while HTTPContext is null</title>

    <link href="/content/bootstrap.min.css" rel="stylesheet">

    <link href="/content/syntaxhighlighter/shcore.css" rel="stylesheet">
    <link href="/content/syntaxhighlighter/shcoredefault.css" rel="stylesheet">

    <link href="/content/s.docs.default.css" rel="stylesheet">
</head>
<body>


    

<style>
    .font-17 {
        font-size: 17px;
    }
</style>



<div class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">
                Documentation
                    <span class="glyphicon glyphicon-chevron-right">
            </span></a>
        </div>

            <ul class="nav navbar-nav">
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle font-17" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                        ReSP<span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="/spmeta2-ex">SPMeta2 VS Extensions</a></li>
                        <li><a href="/spmeta2-spec">SPMeta2 Spec</a></li>
                        <li><a href="/spmeta2-nuget">SPMeta2 NuGet</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="/resp">reSP</a></li>
                    </ul>
                </li>
            </ul>

    </div>
</div>



<div class="container body-content sd-body-content">
    <div class="row">
        



<div class="sub-nav">



    <h2>
            <a href="/resp/inspections/index.html">
                Inspections
            </a>
        
    </h2>

    <ul>
            <li>
                <a class="" href="/resp/getting-started/index.html">
                    Getting Started
                </a>
            </li>
            <li>
                <a class="active" href="/resp/inspections/index.html">
                    Inspections
                </a>
            </li>
            <li>
                <a class="" href="/resp/code-completion/index.html">
                    Code Completion
                </a>
            </li>
            <li>
                <a class="" href="/resp/live-templates/index.html">
                    Live Templates
                </a>
            </li>
            <li>
                <a class="" href="/resp/kb/index.html">
                    KB
                </a>
            </li>

    </ul>
</div>
    </div>

    <div class="row">
        <div class="col-lg-8 col-md-8 col-sm-8">
            <h3>Description</h3>
<p>You do not have elevation of privilege when using SPSecurity.RunWithElevatedPrivileges in (1) Workflow, (2) Timer Job, (3) Feature Receiver or (4) Event handler (SPItemEventReceiver, SPListEventReceiver,SPWebEventReceiver, SPWorkflowEventReceiver) in the follow cases:</p>
<p>I. When HTTPContext (SPContext to be more specific) is null.</p>
<ul>
<li>SharePoint routinely runs your workflows under completely different processes. The result is you cannot use SPContext.Current (in workflow activities you have to use a WorkflowContext instance which provides a Web property).</li>
<li>The SharePoint timer service is a windows service. So SPContext is not accessible and you should pass a site and web Ids(Urls) to the timer job and open new web.</li>
<li>Because you can’t be sure where the FeatureReceiver is being called from (command line, timer service, web ui) you can’t use method of getting a SPSite/SPWeb object over SPContext (instead you can access the context through SPFeatureReceiverProperties.Feature.Parent).</li>
<li>Asynchronous list item event handlers like ItemAdded do not have HTTPContext\SPContext context. Synchronous event handlers can’t also be initiated by a request in browser (for example: initiated from timer job)</li>
</ul>
<p>II. When current thread is not using impersonation or current user is already App Pool account.</p>
<ul>
<li>Workflow runs under App Pool account (However, if this is a workflow created in SharePoint Designer then the default SPD Actions have their permissions trimmed to match those of the person who starts the workflow).</li>
<li>Jobs are executed under SharePoint timer service account (OWSTimer process). RunWithElevatedPrivileges will have no effect.</li>
<li>It is unclear which windows identity a feature event receiver will be running under as we don’t know if it will be called by STSADM (cmd.exe), “Windows Share Services Administration” timer service (WSSADMIN.EXE) or the WebUI (w3wp.exe with the app pools identity).</li>
<li>Generally both synchronous and asynchronous event receivers are executed under current user account. In case of not user initiated, like timer job, see ch.2.</li>
</ul>
<h3>Summary</h3>
<p>You should avoid using SPSecurity.RunWithElevatedPrivileges for elevation of privilege. Instead :</p>
<ul>
<li>to impersonate SP objects use SPUserToken. Note: avoid passing SharePoint objects between different security contexts (SPSite instances). Example: An SPUser object created from one SPSite object cannot be passed reliably to another SPSite object.</li>
<li>to impersonate network calls (DB access) in trusted environment when HTTPContext/SPContext is null use WIN 32 API or WindowsIdentity.Impersonate(token).</li>
</ul>
<p>Examples of Trusted Connection (Windows Authentication):
[TEST.TrustedConnectionSample]</p>
<p>#FAQ
<em>When I can use SPSecurity.RunWithElevatedPrivileges?</em>
If you want to make a network calls, accesses network or file resources under the application pool identity then SPSecurity.RunWithElevatedPrivileges is the only choice. Note: dispose of all objects in the
delegate. Do not pass SharePoint objects out of the RunWithElevatedPrivileges method.</p>
<p><em>Can I use WIN 32 API in web part or other user control to impersonate?</em>
No! SharePoint request must impersonate the calling user’s identity (<identity impersonate="”true”"> in web.config). SharePoint web applications are configured to impersonate the calling user automatically. If you try to suspend this impersonation by using WIN 32 API, your code may fail or behave abnormally.</identity></p>
<h3>Links</h3>
<ul>
<li><a href="http://extreme-sharepoint.com/2012/05/30/impersonation-elevation-of-privileges" target="_blank">Impersonation in SharePoint : An Extreme Overview</a></li>
<li><a href="http://www.sharepoint-tips.com/2007/03/sample-event-handler-to-set-permissions.html" target="_blank">Sample of impersonation not using RunWithElevatedPrivilages</a></li>
<li><a href="http://www.sharepoint-tips.com/2007/03/impersonation-in-event-handlers.html" target="_blank">Impersonation in Event Handlers</a></li>
<li><a href="http://www.sharepoint-tips.com/2007/03/event-handler-impersonation-continued.html" target="_blank">Event handler impersonation – continued</a></li>
<li><a href="http://blog.pentalogic.net/2010/06/sharepoint-feature-receivers-events-details/" target="_blank">SharePoint Feature Receivers – the hidden details</a></li>
</ul>


        </div>
        <div class="col-lg-4 col-md-4 col-sm-4">
            

<div class="sd-sidebar panel panel-default hidden-print hidden-xs hidden-sm affix1">
    <ul class="nav ">
                        <li class="root">

                            <a href="/resp/inspections/index.html">
                                Inspections
                            </a>
                        </li>
                    <li>





                        <a class="root-group collapse group-link" data-toggle="collapse" href="#aspnet">
                            ASP.NET (3)
                        </a>

                        <ul class="nav collapse in" id="aspnet">

                                <li>

                                    <a href="/resp/inspections/aspnet/resp516902.html">
                                        SPDataSource.Scope is missed in page
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/aspnet/resp516905.html">
                                        SPGridView.AutoGenerateColumns in page
                                    </a>
                                </li>
                        </ul>
                    </li>
                    <li>





                        <a class="root-group collapse group-link" data-toggle="collapse" href="#csharp">
                            C# (45)
                        </a>

                        <ul class="nav collapse in" id="csharp">

                                <li>

                                    <a href="/resp/inspections/csharp/resp510242.html">
                                        Avoid $ as jQuery reference
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510239.html">
                                        Avoid custom logging
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510240.html">
                                        Avoid SPWeb.Properties usage
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510202.html">
                                        ConfigurationManager is used
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510206.html">
                                        Consider Secure Store Service usage
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510212.html">
                                        DirectorySearcher is used
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510251.html">
                                        EntityEditor.Entities is used
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510236.html">
                                        General exception is suppressed
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510257.html">
                                        gProcessingId parameter is missed for SPSite.AddWorkItem()
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510232.html">
                                        Inappropriate PublishingWeb.GetPublishingPages() usage
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510209.html">
                                        Inappropriate SPList collection usage
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510227.html">
                                        Inappropriate taxonomy collection usage
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510258.html">
                                        Inappropriate usage of SPContentType.Fields
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510247.html">
                                        Incorrect SPView usage
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510223.html">
                                        jQuery(document).ready in CSharp code
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510225.html">
                                        Magic string is used
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510238.html">
                                        Missing SPUrlZone param in SPSite constructor
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510241.html">
                                        Not logged exception found
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510245.html">
                                        PortalLog is used
                                    </a>
                                </li>
                                <li class="active">

                                    <a href="/resp/inspections/csharp/resp510244.html">
                                        RunWithElevatedPrivileges is used while HTTPContext is null
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510261.html">
                                        SPContext objects are disposed
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510222.html">
                                        SPContext.Current is used outside web context
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510218.html">
                                        SPDataSource.Scope is missed
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp512101.html">
                                        SPFeature activated via code
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510226.html">
                                        SPListItem.File is used
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510208.html">
                                        SPMonitoredScope should be used
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510243.html">
                                        SPPersistedObject is updated
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510210.html">
                                        SPQuery.Scope is missed
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510252.html">
                                        SPUtility.SendEmail usage while SPContext is null
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510205.html">
                                        SPView.Scope is missed
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510249.html">
                                        SPWebPartManager is used while HTTPContext is null
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510234.html">
                                        Static SP-object used as field
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510201.html">
                                        Thread.Sleep() usage
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510259.html">
                                        Unsafe cast on SPItemEventDataCollection.Item
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510213.html">
                                        Unsafe cast on SPListItem
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510235.html">
                                        Unsafe SPObject.Name == &lt;string&gt; comparison
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510228.html">
                                        Unsafe url concatenation
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510254.html">
                                        Use FeatureIds class
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510255.html">
                                        Use FieldId class
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510203.html">
                                        Use PropertyConstants class
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510256.html">
                                        Use SPBuiltInFieldId class
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510250.html">
                                        Use try-catch for SPFile.Exists
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510204.html">
                                        UserProfileManager.GetEnumerator() is used
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/csharp/resp510253.html">
                                        UTC time is used
                                    </a>
                                </li>
                        </ul>
                    </li>
                    <li>





                        <a class="root-group collapse group-link" data-toggle="collapse" href="#javascript">
                            Java Script (9)
                        </a>

                        <ul class="nav collapse" id="javascript">

                                <li>

                                    <a href="/resp/inspections/javascript/resp516804.html">
                                        Avoid jQuery(document).ready in ASCX control
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/javascript/resp518902.html">
                                        Avoid jQuery(document).ready in js file
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/javascript/resp517303.html">
                                        Avoid jQuery(document).ready in master page
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/javascript/resp516903.html">
                                        Avoid jQuery(document).ready in page
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/javascript/resp518901.html">
                                        Avoid using $ in js file
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/javascript/resp517301.html">
                                        Avoid using $ in master page
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/javascript/resp516901.html">
                                        Avoid using $ in pages
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/javascript/resp516801.html">
                                        Avoid using $ in web contol
                                    </a>
                                </li>
                        </ul>
                    </li>
                    <li>





                        <a class="root-group collapse group-link" data-toggle="collapse" href="#xml">
                            XML (35)
                        </a>

                        <ul class="nav collapse" id="xml">

                                <li>

                                    <a href="/resp/inspections/xml/resp515205.html">
                                        Avoid comments for content types
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515201.html">
                                        Avoid list content types
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515115.html">
                                        Avoid mixed 'ID' and 'Id' names
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515403.html">
                                        Avoid system list names for list instance
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515108.html">
                                        Avoid underscore in field name
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515501.html">
                                        Consider hidden list templates
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515204.html">
                                        Consider Overwrite='TRUE' for content types
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515104.html">
                                        Consider Overwrite='TRUE' for field
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515502.html">
                                        Declare empty Fields element
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515203.html">
                                        Deploy content types correctly
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515103.html">
                                        Deploy lookup field correctly
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515101.html">
                                        Deploy Taxonomy field correctly
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515109.html">
                                        Duplicate field Name
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515110.html">
                                        Duplicate field StaticName
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515404.html">
                                        Duplicate list instance Title
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515402.html">
                                        Duplicate list instance Url
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515504.html">
                                        Ensure Folder ContentTypeRef in list definition
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp510004.html">
                                        Entity is not provisioned
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp516401.html">
                                        Improve web part definition
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp516402.html">
                                        Improve web part module
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515105.html">
                                        Incorrect 'ID' attr name
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515114.html">
                                        Incorrect lookup field provision
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515112.html">
                                        Incorrect 'Note' field index
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515106.html">
                                        Incorrect 'ShowField' attr value
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515111.html">
                                        Incorrect 'StaticName' length
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515113.html">
                                        Internal and static field names are different
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515202.html">
                                        Multiple content type groups in element file
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515102.html">
                                        Multiple field groups in element file
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515107.html">
                                        Prevent field from deletion
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515505.html">
                                        Prevent list from deletion
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515506.html">
                                        Repeat calculated fields in list definition
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515507.html">
                                        Repeat lookup fields in list definition
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515503.html">
                                        Taxonomy field in list definition
                                    </a>
                                </li>
                                <li>

                                    <a href="/resp/inspections/xml/resp515405.html">
                                        Wrong FeatureId for list instance
                                    </a>
                                </li>
                        </ul>
                    </li>

    </ul>



</div>
        </div>
    </div>
</div>

<div class="container sps-footer">
    <div class="row">
        <hr>
        <footer>
            <p>Copyright © SubPoint Solutions 2016. Built with "Bootstrap" theme.</p>
        </footer>
    </div>
</div>


    <script src="/scripts/jquery-1.9.1.min.js"></script>
    <script src="/scripts/bootstrap.js"></script>

    <script src="/scripts/syntaxhighlighter/shcore.js"></script>
    <script src="/scripts/syntaxhighlighter/shbrushcsharp.js"></script>
    <script src="/scripts/syntaxhighlighter/shbrushxml.js"></script>


    

    


    <script>

        jQuery(document).ready(function () {

            jQuery('code.language-cs')
                .addClass('brush: csharp;');

            jQuery('code.language-xml')
                .addClass('brush: xml;');

            SyntaxHighlighter.defaults['quick-code'] = false;
            SyntaxHighlighter.config.tagName = 'code';
            SyntaxHighlighter.all();
        });

    </script>



</body></html>